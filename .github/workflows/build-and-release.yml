name: Build and Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check branch
        id: check_branch
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Branch: $BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

          if [ "$BRANCH_NAME" != "main" ]; then
            echo "Not on main branch. Workflow will run but skip release."
            echo "is_main=false" >> $GITHUB_OUTPUT
          else
            echo "On main branch. Will proceed with full workflow."
            echo "is_main=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate release tag
        id: generate_tag
        run: |
          TIMESTAMP="$(date -u +'%Y%m%d%H%M')"
          RELEASE_TAG="v${TIMESTAMP}"
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $RELEASE_TAG"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Download icon sources
        run: |
          ./scripts/download-aws-icons.sh
          ./scripts/download-azure-icons.sh
          ./scripts/download-m365-icons.sh
          ./scripts/download-d365-icons.sh
          ./scripts/download-entra-icons.sh
          ./scripts/download-powerplatform-icons.sh
          ./scripts/download-fabric-icons.sh
          ./scripts/download-kubernetes-icons.sh
          ./scripts/download-gilbarbara-icons.sh
          ./scripts/download-lobe-icons.sh
          ./scripts/download-gcp-icons.sh

      - name: Prebuild icons
        working-directory: src/prebuild
        run: |
          npm ci
          npm run build

      - name: Build Figma plugin
        working-directory: src/figma/plugin
        run: |
          npm ci
          npm run build

      - name: Build PowerPoint add-in
        working-directory: src/powerpoint/add-in
        run: |
          npm ci
          npm run build

      - name: Build Google Slides add-on
        working-directory: src/google-slides/addon
        run: |
          npm ci
          npm run build

      - name: Build Draw.io icon libraries
        working-directory: src/drawio/iconlib
        run: |
          npm ci
          npm run build

      - name: Build VSCode extension
        working-directory: src/vscode/extension
        run: |
          npm ci
          npm run package

      - name: Package to dist
        run: |
          mkdir -p dist

          # Figma
          cd src/figma/plugin/out
          zip -r $GITHUB_WORKSPACE/dist/cloud-architect-kits-figma-plugin.zip .
          cd $GITHUB_WORKSPACE

          # PowerPoint
          cd src/powerpoint/add-in/out
          zip -r $GITHUB_WORKSPACE/dist/cloud-architect-kits-powerpoint-addin.zip .
          cd $GITHUB_WORKSPACE

          # Google Slides
          cd src/google-slides/addon/out
          zip -r $GITHUB_WORKSPACE/dist/cloud-architect-kits-google-slides-addon.zip .
          cd $GITHUB_WORKSPACE

          # Draw.io
          cd src/drawio/iconlib/out
          zip -r $GITHUB_WORKSPACE/dist/cloud-architect-kits-drawio-iconlib.zip .
          cd $GITHUB_WORKSPACE

          # VSCode
          if [ -f src/vscode/extension/*.vsix ]; then
            cp src/vscode/extension/*.vsix dist/
          fi

      - name: Check for changes in dist
        id: check_changes
        if: steps.check_branch.outputs.is_main == 'true'
        run: |
          # Get the latest release tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            echo "No previous release found. Will create first release."
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Latest release tag: $LATEST_TAG"
          echo "Comparing with previous release..."

          # Calculate checksums of current build
          cd dist
          sha256sum * 2>/dev/null | sort > /tmp/current-checksums.txt
          cd ..

          # Try to get previous release assets and compare
          # Download the previous release packages
          gh release download $LATEST_TAG --pattern "*.zip" --pattern "*.vsix" --dir /tmp/previous-dist 2>/dev/null || {
            echo "Could not download previous release assets. Will create new release."
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          }

          # Calculate checksums of previous release
          cd /tmp/previous-dist
          sha256sum * 2>/dev/null | sort > /tmp/previous-checksums.txt
          cd -

          # Compare checksums
          if diff /tmp/current-checksums.txt /tmp/previous-checksums.txt > /dev/null 2>&1; then
            echo "=========================================="
            echo "No changes detected in build artifacts."
            echo "Build output is identical to $LATEST_TAG"
            echo "=========================================="
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "=========================================="
            echo "Changes detected in build artifacts."
            echo "Will create new release."
            echo "=========================================="
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Show diff summary
            echo ""
            echo "Checksum differences:"
            diff /tmp/current-checksums.txt /tmp/previous-checksums.txt || true
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cloud-architect-kits-${{ env.RELEASE_TAG }}
          path: dist/
          retention-days: 30

      - name: Create GitHub Release
        if: steps.check_branch.outputs.is_main == 'true' && steps.check_changes.outputs.has_changes == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Cloud Architect Kits ${{ env.RELEASE_TAG }}
          body: |
            ## Cloud Architect Kits - Release ${{ env.RELEASE_TAG }}

            ### Packages Included
            - **Figma Plugin**: `cloud-architect-kits-figma-plugin.zip`
            - **PowerPoint Add-in**: `cloud-architect-kits-powerpoint-addin.zip`
            - **Google Slides Add-on**: `cloud-architect-kits-google-slides-addon.zip`
            - **Draw.io Icon Libraries**: `cloud-architect-kits-drawio-iconlib.zip`
            - **VSCode Extension**: `cloud-architect-kits-vscode-extension-1.0.0.vsix`

            ### Installation Instructions
            See README.md for detailed installation instructions for each platform.
          files: |
            dist/cloud-architect-kits-figma-plugin.zip
            dist/cloud-architect-kits-powerpoint-addin.zip
            dist/cloud-architect-kits-google-slides-addon.zip
            dist/cloud-architect-kits-drawio-iconlib.zip
            dist/cloud-architect-kits-vscode-extension-*.vsix
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Non-main branch message
        if: steps.check_branch.outputs.is_main != 'true'
        run: |
          echo "=========================================="
          echo "âœ… Build completed successfully!"
          echo "Branch: ${{ steps.check_branch.outputs.branch }}"
          echo ""
          echo "Not on main branch - skipping release."
          echo "Artifacts have been uploaded for inspection."
          echo "=========================================="

      - name: Skip release message
        if: steps.check_branch.outputs.is_main == 'true' && steps.check_changes.outputs.has_changes != 'true'
        run: |
          echo "=========================================="
          echo "No changes detected in build output."
          echo "Skipping release creation."
          echo "=========================================="
